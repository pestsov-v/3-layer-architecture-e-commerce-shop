# Контроллеры

Контроллеры организованы путём навешивания различных запросов на пути маршрутизации, другими словами, когда пользователь совершает переходы по приложению, он отправляет запросы, которые имеют определенный метод запроса и которые функционируют по определенному маршруту (route).

⬅️ **Подробную информацию обо всех маршрутах смотреть в разделе [Маршрутизация](routes.md)** <br/>
⬅️ **Подробную информацию обо всех контроллерах смотреть в разделе [Представления](views.md)** <br/>
↩️ [К оглавлению документации](../README.md) <br/> 

## Оглавление раздела
- [Контроллеры](#контроллеры)
  - [Оглавление раздела](#оглавление-раздела)
  - [Структура контроллеров](#структура-контроллеров)
  - [Контроллеры страницы "Главная"](#контроллеры-страницы-главная)
    - [Метод запроса get по маршруту '/'](#метод-запроса-get-по-маршруту-)
    - [Контроллеры страницы "Курсы"](#контроллеры-страницы-курсы)
      - [Метод запроса get по маршруту '/courses'](#метод-запроса-get-по-маршруту-courses)
      - [Метод запроса get по маршруту '/courses/:id'](#метод-запроса-get-по-маршруту-coursesid)
      - [Метод запроса get по маршруту '/courses/:id/edit'](#метод-запроса-get-по-маршруту-coursesidedit)
      - [Метод запроса post по маршруту '/courses/edit'](#метод-запроса-post-по-маршруту-coursesedit)
      - [Метод запроса post по маршруту '/courses/remove'](#метод-запроса-post-по-маршруту-coursesremove)
    - [Контроллеры страницы "Добавить курс"](#контроллеры-страницы-добавить-курс)
      - [Метод запроса get по маршруту '/add'](#метод-запроса-get-по-маршруту-add)
      - [Метод запроса post по маршруту '/add'](#метод-запроса-post-по-маршруту-add)
    - [Контроллеры страницы "Профиль"](#контроллеры-страницы-профиль)
      - [Метод запроса get по маршруту '/profile'](#метод-запроса-get-по-маршруту-profile)
      - [Метод запроса post по маршруту '/profile'](#метод-запроса-post-по-маршруту-profile)
    - [Контроллеры страницы "Корзина"](#контроллеры-страницы-корзина)
      - [Метод запроса get по маршруту '/card'](#метод-запроса-get-по-маршруту-card)
      - [Метод запроса post по маршруту '/card/add'](#метод-запроса-post-по-маршруту-cardadd)
      - [Метод запроса delete по маршруту '/card/remove/:id'](#метод-запроса-delete-по-маршруту-cardremoveid)
    - [Контроллеры страницы "Заказы"](#контроллеры-страницы-заказы)
      - [Метод запроса get по маршруту '/orders'](#метод-запроса-get-по-маршруту-orders)
      - [Метод запроса post по маршруту '/orders'](#метод-запроса-post-по-маршруту-orders)
    - [Контроллеры страницы "Вход / Выход"](#контроллеры-страницы-вход--выход)
      - [Метод запроса get по маршруту '/auth/login'](#метод-запроса-get-по-маршруту-authlogin)
      - [Метод запроса get по маршруту '/auth/loguot'](#метод-запроса-get-по-маршруту-authloguot)
      - [Метод запроса get по маршруту '/auth/reset'](#метод-запроса-get-по-маршруту-authreset)
      - [Метод запроса get по маршруту '/auth/password/:token'](#метод-запроса-get-по-маршруту-authpasswordtoken)
      - [Метод запроса post по маршруту '/auth/login'](#метод-запроса-post-по-маршруту-authlogin)
      - [Метод запроса post по маршруту '/auth/register'](#метод-запроса-post-по-маршруту-authregister)
      - [Метод запроса post по маршруту '/auth/reset'](#метод-запроса-post-по-маршруту-authreset)
      - [Метод запроса post по маршруту '/auth/password'](#метод-запроса-post-по-маршруту-authpassword)


## Структура контроллеров

Таблица всех контроллеров с учётом страниц и маршрутизаторов:

|   Страница    | Маршрутизатор | Метод запроса |    URL-путь запроса     |                                            Функция                                        |
| :-----------: | :-----------: | :---------: | :---------------------: | :---------------------------------------------------------------------------------------: |
|    Главная    |  homeRoutes   |     get     |           "/"           |                              Визуализация страницы "Главная"                              |  
|    Главная    |  homeRoutes   |     get     |           "/"           |                            Определение флага активности ссылки                            | 
|     Курсы     | coursesRoutes |     get     |        "/courses"       |                               Визуализация страницы "Курсов"                              |
|     Курсы     | coursesRoutes |     get     |        "/courses"       |                            Определение флага активности ссылки                            |
|     Курсы     | coursesRoutes |     get     |        "/courses"       |                              Поиск всех курсов в базе данных                              |
|     Курсы     | coursesRoutes |     get     |        "/courses"       |                          Визуализация всех курсов из базы данных                          |
|     Курсы     | coursesRoutes |     get     |      "/courses/:id"     |                             Визуализация страницы одного курса                            |
|     Курсы     | coursesRoutes |     get     |      "/courses/:id"     |                          Визуализация одного курса из базы данных                         |
|     Курсы     | coursesRoutes |     get     |   "/courses/:id/edit"   |                              Проверка на правильность запроса                             |
|     Курсы     | coursesRoutes |     get     |   "/courses/:id/edit"   |                                     Поиск курса по ID                                     |
|     Курсы     | coursesRoutes |     get     |   "/courses/:id/edit"   |                 Проверка на доступность редактирование курса пользователем                |
|     Курсы     | coursesRoutes |     get     |   "/courses/:id/edit"   |                         Визуализация страницы "Редактировать курс"                        |
|     Курсы     | coursesRoutes |     post    |     "/courses/edit"     |                               Проверка валидации курса по ID                              |
|     Курсы     | coursesRoutes |     post    |     "/courses/edit"     |                                 Поиск курса в базе данных                                 |
|     Курсы     | coursesRoutes |     post    |     "/courses/edit"     |            Подтягивание всех существующих данных курса для его редактирования             |
|     Курсы     | coursesRoutes |     post    |     "/courses/edit"     |           Сохранение редактируемого курса и перенаправление на страницу "Курсы"           |
|     Курсы     | coursesRoutes |     post    |    "/courses/remove"    |                            Удаление одного курса из базы данных                           |
|     Курсы     | coursesRoutes |     post    |    "/courses/remove"    |                            Перенаправление на страницу "Курсы"                            |
| Добавить курс |   addRoutes   |     get     |         "/add"          |                        Визуализация страницы "Добавить новый курс"                        |
| Добавить курс |   addRoutes   |     get     |         "/add"          |                            Определение флага активности ссылки                            |
| Добавить курс |   addRoutes   |     post    |         "/add"          |                            Проверка валидатором на пустые поля                            | 
| Добавить курс |   addRoutes   |     post    |         "/add"          |                                    Создание нового курса                                  | 
| Добавить курс |   addRoutes   |     post    |         "/add"          |                            Сохранение нового курса в базе данных                          | 
|    Профиль    | profileRoutes |     get     |       "/profile"        |                               Визуализация страницы "Профиль"                             |
|    Профиль    | profileRoutes |     get     |       "/profile"        |                             Определение флага активности ссылки                           |
|    Профиль    | profileRoutes |     get     |       "/profile"        |                              Визуализация данных пользователя                             |
|    Профиль    | profileRoutes |     post    |       "/profile"        |                                  Поиск пользователя по ID                                 |
|    Профиль    | profileRoutes |     post    |       "/profile"        |         Подтягивание всех существующих данных пользователя для его редактирования         |
|    Профиль    | profileRoutes |     post    |       "/profile"        |                                Редактирование имени пользователя                          |
|    Профиль    | profileRoutes |     post    |       "/profile"        |      Сохранение редактируемого пользователя и перенаправление на страницу "Профиль"       |
|    Корзина    |  сardRoutes   |     get     |        "/card"          |                             Визуализация корзины пользователя                             |
|    Корзина    |  сardRoutes   |     get     |        "/card"          |                            Определение флага активности ссылки                            |
|    Корзина    |  сardRoutes   |     get     |        "/card"          |                                Расчёт стоимости всех курсов                               |
|    Корзина    |  сardRoutes   |     get     |        "/card"          |                               Визуализация страницы "Корзина"                             |
|    Корзина    |  сardRoutes   |     post    |      "/card/add"        |                                     Поиск курса по ID                                     |
|    Корзина    |  сardRoutes   |     post    |      "/card/add"        |             Добавление курса в корзину и перенаправление на страницу "Корзина"            |
|    Корзина    |  сardRoutes   |    delete   |   "/card/remove/:id"    |                               Удаление курса по ID из корзины                             |
|    Корзина    |  сardRoutes   |    delete   |   "/card/remove/:id"    |                     Пересчёт стоимости всех курсов после удаления курса                   |
|    Заказы     | ordersRoutes  |     get     |        "/orders"        |                             Поиск заказов пользователя по ID                              |
|    Заказы     | ordersRoutes  |     get     |        "/orders"        |                              Визуализация страницы "Заказы"                               |
|    Заказы     | ordersRoutes  |     get     |        "/orders"        |                               Подсчёт стоимости всех курсов                               |
|    Заказы     | ordersRoutes  |     post    |        "/orders"        |                           Формирование заказа для пользователя                            |
|    Заказы     | ordersRoutes  |     post    |        "/orders"        |                          Подсчёт всех курсов и суммы этих курсов                          |
|    Заказы     | ordersRoutes  |     post    |        "/orders"        |                                Формирование нового заказа                                 |
|    Заказы     | ordersRoutes  |     post    |        "/orders"        |                                     Сохранение заказа                                     |
|    Заказы     | ordersRoutes  |     post    |        "/orders"        |                  Очищение корзины и перенаправление на страницу "Заказы"                  |
| Вход / Выход  |  authRoutes   |     get     |      "/auth/login"      |                               Визуализация страницы "Вход"                                |
| Вход / Выход  |  authRoutes   |     get     |      "/auth/login"      |                            Определение флага активности ссылки                            |
| Вход / Выход  |  authRoutes   |     get     |      "/auth/login"      |                        Проверка на подлинность логика пользователя                        |
| Вход / Выход  |  authRoutes   |     get     |      "/auth/login"      |                        Проверка на подлинность пароль пользователя                        |
| Вход / Выход  |  authRoutes   |     get     |      "/auth/loguot"     |           Уничтожение сессии пользователя и перенаправление на страницу "Вход"            |
| Вход / Выход  |  authRoutes   |     get     |       "/auth/reset"     |                            Визуализация страницы "Смена пароля"                           |
| Вход / Выход  |  authRoutes   |     get     |       "/auth/reset"     |                 Проверка на существующую почту пользователя в базе данных                 |
| Вход / Выход  |  authRoutes   |     get     | "/auth/password/:token" |                         Проверка на действенный токен пользователя                        |
| Вход / Выход  |  authRoutes   |     get     | "/auth/password/:token" |                       Поиск пользователя по действительному токену                        |
| Вход / Выход  |  authRoutes   |     get     | "/auth/password/:token" |                     Проверка на существование уникально пользователя                      |
| Вход / Выход  |  authRoutes   |     get     | "/auth/password/:token" |                         Визуализация страницы "Востановить доступ"                        |
| Вход / Выход  |  authRoutes   |     get     | "/auth/password/:token" |                Проверка на восстановление доступа конкретному пользователю                |
| Вход / Выход  |  authRoutes   |     post    |       "/auth/login"     |                      Проверка данных пользователя для входа в аккаунт                     |
| Вход / Выход  |  authRoutes   |     post    |       "/auth/login"     |              Получение пользователем авторизированных прав и открытие сессии              |
| Вход / Выход  |  authRoutes   |     post    |       "/auth/login"     |                              Проверка на правильность пароля                              |
| Вход / Выход  |  authRoutes   |     post    |      "/auth/register"   |           Создание аккаунта нового пользователя и шифрование пароля пользователя          |
| Вход / Выход  |  authRoutes   |     post    |      "/auth/register"   |                       Сохранение данных пользователя в базе данных                        |
| Вход / Выход  |  authRoutes   |     post    |      "/auth/register"   |                   Отправка письма пользователю об успешной регистрации                    |
| Вход / Выход  |  authRoutes   |     post    |       "/auth/reset"     |                            Поиск пользователю в базе данных                               |
| Вход / Выход  |  authRoutes   |     post    |       "/auth/reset"     |                           Формирование токена пользователя                                |
| Вход / Выход  |  authRoutes   |     post    |       "/auth/reset"     |          Отправка сообщения с новым токеном на почту существующему пользователю           |
| Вход / Выход  |  authRoutes   |     post    |     "/auth/password"    |                                 Поиск пользователя по ID                                  |
| Вход / Выход  |  authRoutes   |     post    |     "/auth/password"    | Сохранение нового пароля пользователя в базе данных и перенаправление на страницу "Логин" |
| Вход / Выход  |  authRoutes   |     post    |     "/auth/password"    |                               Проверка на срок жизни токена                               |

⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>
↩️ [К оглавлению документации](../README.md) <br/>

## Контроллеры страницы "Главная"

Таблица всех контроллеров страницы "Главная":
| Метод запроса | URL-путь запроса |                     Функция                  |
| :---------: | :--------------: | :------------------------------------------: |
|     get     |       "/"        |        Визуализация страницы "Главная"       |  
|     get     |       "/"        |      Определение флага активности ссылки     |  

⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>
↩️ [К оглавлению документации](../README.md) <br/>

---

### Метод запроса get по маршруту '/'

Код метода запроса get по маршруту '/': <br/>
```node
router.get('/', (req, res) => {
  res.render('index', {
    title: 'Главная страница',
    isHome: true
  })
})
```
Где:<br/>
**1. Визуализация страницы "Главная":**<br/>
Логика передачи данных для последующей визуализации:<br/>
```node
...
res.render('index', {
    title: 'Главная страница',
    ...
  })
```
Где:<br/>
- `res.render('index', {})` - метод render объекта response, который визуализирует данные приходящие из файла index.hbs.<br/>
- `title` - ключ принимающий значение 'Главная страница'. Значение визуализируется в названии графы страницы. <br/>

**2. Определение флага активности ссылки:** <br/>
Логика определения флага активности ссылки: <br/>
```node
router.get('/', (req, res) => {
    ...
    isHome: true
  })
...
})
```
Где: <br/>
- `isHome` - ключ принимающий значение true. isHome является флагом, переключающий активность ссылки при её нажатии. <br/>

⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>

### Контроллеры страницы "Курсы"

**Таблица всех контроллеров страницы "Курсы":**
| Метод запроса |    URL-путь запроса     |                                  Функция                              |
| :---------: | :---------------------: | :-------------------------------------------------------------------: |
|     get     |        "/courses"       |                     Визуализация страницы "Курсов"                    |
|     get     |        "/courses"       |                  Определение флага активности ссылки                  |
|     get     |        "/courses"       |                    Поиск всех курсов в базе данных                    |
|     get     |        "/courses"       |                Визуализация всех курсов из базы данных                |
|     get     |      "/courses/:id"     |                   Визуализация страницы одного курса                  |
|     get     |      "/courses/:id"     |                Визуализация одного курса из базы данных               |
|     get     |   "/courses/:id/edit"   |                    Проверка на правильность запроса                   |
|     get     |   "/courses/:id/edit"   |                           Поиск курса по ID                           |
|     get     |   "/courses/:id/edit"   |       Проверка на доступность редактирование курса пользователем      |
|     get     |   "/courses/:id/edit"   |               Визуализация страницы "Редактировать курс"              |
|     post    |     "/courses/edit"     |                     Проверка валидации курса по ID                    |
|     post    |     "/courses/edit"     |                       Поиск курса в базе данных                       |
|     post    |     "/courses/edit"     |  Подтягивание всех существующих данных курса для его редактирования   |
|     post    |     "/courses/edit"     | Сохранение редактируемого курса и перенаправление на страницу "Курсы" |
|     post    |    "/courses/remove"    |                  Удаление одного курса из базы данных                 |
|     post    |    "/courses/remove"    |                  Перенаправление на страницу "Курсы"                  |

⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>
↩️ [К оглавлению документации](../README.md) <br/>

---

#### Метод запроса get по маршруту '/courses'

Код метода запроса get по маршруту '/courses': <br/>
```node
router.get('/', async (req, res) => {
  try {
    const courses = await Course.find()
    .populate('userId', 'email name')
    .select('price title img')

    res.render('courses', {
      title: 'Курсы',
      isCourses: true,
      userId: req.user ? req.user._id.toString() : null,
      courses
  })
  } catch (e) {
    console.log(e)
  }
})
```
Где:<br/>
**1. Визуализация страницы "Курсы":** <br/>
Логика передачи данных для последующей визуализации страницы "Курсы": <br/>
```node
res.render('courses', {})
```
Где:<br/>
- `res.render('courses', {})` - метод render объекта response, который визуализирует данные приходящие из файла courses.hbs. <br/>

**2. Определение флага активности ссылки:** <br/>
При выборе страницы из navbar, активная страница затемняет свой блок в строке navbar. Логика определения флага активности ссылки: <br/>
```node
...
isCourses: true
...
```
Где: <br/>
- `isCourses` - флагом принимающий значение true, является переключателем активности ссылки при её нажатии. <br/>

**3. Поиск всех курсов в базе данных:** <br/>
Логика поиска всех возможных курсов: <br/>
```node
    const courses = await Course.find()
    .populate('userId', 'email name')
    .select('price title img')
```
Где: <br/>
- `Course.find()` - метод find модели курсов Course, который ищет все курсы из коллекции Course и возвращает эти данные. <br/>
- `populate` - метод проверяющий, возвращающие данные, в которых наявны: ID пользователя userId, почта и имя email name.<br/>
- `select` - метод возвращающий значения ключей цены price, заголовка title и пути к картинке img. <br/>

**4. Визуализация всех курсов из базы данных:** <br/>
Логика передачи данных всех курсов для последующей визуализации шаблонизатором страницы "Курсов" и всех курсов находящиеся в коллекции курсов в `MongoDB`: <br/>
```node
res.render('courses', {
  ...
  courses
})
```
Где: <br/>
- `res.render('courses', {})` - метод render объекта response, который визуализирует данные приходящие из файла courses.hbs. <br/>
- `courses` - ключ передающий значение всех курсов courses. <br/>

⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>

#### Метод запроса get по маршруту '/courses/:id'

---

Код метода запроса get по маршруту '/courses/:id': <br/>
```node
router.get('/:id', async (req, res) => {
  try {
    const course = await Course.findById(req.params.id)
    res.render('course', {
      layout: 'empty',
      title: `Курс ${course.title}`,
      course
    })
  } catch (e) {
    console.log(e)
  }
})
```
Где: <br/>
**1. Визуализация страницы одного курса:** <br/>
Логика передачи данных для последующей визуализации страницы одного курса: <br/>
```node
res.render('course', {
      layout: 'empty',
      title: `Курс ${course.title}`,
      ...
    })
```
Где: <br/>
- `res.render('course', {})` - метод render объекта response, который визуализирует данные приходящие из файла course.hbs.<br/>
- `layout` - ключ передающий значение типа шаблона empty для визуализации структуры шаблона empty. <br/>
- `title` - ключ передающий значение Курс ${course.title}, в шаблонизаторе, которое фигурирует как заголовок с динамическим значением заголовка.<br/>

**2. Визуализация одного курса из базы данных:** <br/>
Логика нахождения и передачи данных для визуализации одного курса из базы данных: <br/>
```node
const course = await Course.findById(req.params.id)

res.render('course', {
  ...
  course
})
```
Где: <br/>
- `Course.findById(req.params.id)` - метод findById модели Course, который ищет курс по входящему запросу с ID req.params.id из коллекции Сourse и возвращает эти данные. <br/> 
- `course` - ключ принимающий одноименное значение, в котором хранится данные одного курса определённого по ID. <br/>

⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>

#### Метод запроса get по маршруту '/courses/:id/edit'

---

Код метода запроса get по маршруту '/courses/:id/edit': <br/>
```node
router.get('/:id/edit', auth, async (req, res) => {
  if (!req.query.allow) {
    return res.redirect('/')
  }
  try {
    const course = await Course.findById(req.params.id)

    if (course.userId.toString() !== req.user._id.toString()) {
      return res.redirect('/courses')
    }
    
    res.render('course-edit', {
      title: `Редактировать ${course.title}`,
      course
  })
  } catch (e) {
    console.log(e)
  }
})
```
Где: <br/>
**1. Проверка на правильность запроса:** <br/>
Логика проверки на правильность запроса: <br/>
```node
...
  if (!req.query.allow) {
    return res.redirect('/')
  }
...
```
Где: <br/>
- `!req.query.allow` - условие проверки, если запрос не подтвержден. <br/> 
- `res.redirect()` - метод redirect объекта ответа response перенаправление на страницу с маршрутом '/'. <br/>

**2. Поиск курса по ID:** <br/>
Логика поиска курса по ID: <br/>
```node
...
const course = await Course.findById(req.params.id)
...
```
Где: <br/>
- `Course.findById()` - метод findById модели Course, который ищет курс по входящему запросу с ID req.params.id из коллекции Course и возвращает эти данные. <br/>

**3. Проверка на доступность редактирование курса пользователем:** <br/>
При создании курса, каждый курс получает уникальний ID, а у пользователя создавшего курс добавляется ID этого курса. Таким образом каждый курс закреплён за пользователем, который создал этот курс и права редактирование и удаление курса по ID есть только у пользователя, который его создал. Код проверки на доступность редактирования курса ниже: <br/>
```node
...
if (course.userId.toString() !== req.user._id.toString()) {
      return res.redirect('/courses')
    }
...
```
Где: <br/>
- `course.userId.toString() !== req.user._id.toString()` - проверка, которая сравнивает ID курса с ID пользователя, который создал этот курс.<br/>
- `res.redirect()` - метод redirect объекта ответа response перенаправление на страницу с маршрутом '/courses'. <br/>

**4. Визуализация страницы "Редактировать курс":** <br/>
Логика передачи данных для последующей визуализации страницы "Редактировать курс" шаблонизатором: <br/>
```node
...
res.render('course-edit', {
      title: `Редактировать ${course.title}`,
      ...
  })
```
Где: <br/>
- `res.render('course-edit', {})` - метод render объекта response, который визуализирует данные приходящие из файла course-edit.hbs. <br/>
- `title` - ключ передающий значение Редактировать ${course.title}, в шаблонизаторе которое фигурирует как заголовок с динамическим значением заголовка.<br/>

**5. Визуализация одного курса:** <br/>
Логика поиска данных и визуализацию данных одного курса: <br/>
```node
const course = await Course.findById(req.params.id)
  ...
res.render('course-edit', {
      ...,
      course
  })
```
Где: <br/>
- `Course.findById()` - метод findById модели Course, который ищет курс по входящему запросу с ID req.params.id из коллекции Course и возвращает эти данные. <br/>
- `res.render('course-edit', {})` - метод render объекта response, который визуализирует данные приходящие из файла course-edit.hbs. <br/>
- `course` - ключ принимающий одноименное значение, в котором хранится данные одного курса определенного по ID. <br/>

⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>

---

#### Метод запроса post по маршруту '/courses/edit'

Код метода запроса post по маршруту '/courses/edit': <br/>
```node
router.post('/edit', auth, courseValidators, async (req, res) => {
  const errors = validationResult(req)
  const {id} = req.body

  if (!errors.isEmpty()) {
    return res.status(422).redirect(`/courses/${id}/edit?allow=true`)
  }

  try {
    delete req.body.id
    const course = await Course.findById(id)
    if (course.userId.toString() !== req.user._id.toString()) {
      res.redirect('/courses')
    }
    Object.assign(course, req.body)
    await course.save()
    res.redirect('/courses')
  } catch (e) {
    console.log(e)
  }
})
```
Где: <br/>
**1. Проверка валидации курса по ID:** <br/>
Логика проверки на существование определенного курса по ID: <br/>
```node
...
  if (!errors.isEmpty()) {
    return res.status(422).redirect(`/courses/${id}/edit?allow=true`)
  }
...
```
Где: <br/> 
- `!errors.isEmpty()` - проверка на пустоту запроса с помощью функции isEmpty() библиотеки express-validator. <br/> 
- `res.status(422)` - метод status объекта response отправляющий необходимый метод запроса. <br/>
- `redirect()` - метод redirect объекта ответа response перенаправление на страницу с маршрутом '/courses/${id}/edit?allow=true'. <br/>

**2. Поиск курса в базе данных:** <br/>
Логика поиска курса в базе данных: <br/>
```node
const course = await Course.findById(id)
```
Где: <br/>
- `Course.findById()` - метод findById модели Course, который ищет курс по входящему запросу с ID id из коллекции Course и возвращает эти данные. id - это вытянутый ключ из запроса тела request - req.body. <br/>

**3. Подтягивание определенного курса для его редактирования:** <br/>
Логика поиска определённого курса по ID и последующая его передача: <br/>
```node
const course = await Course.findById(id)
...
Object.assign(course, req.body)
...
```
Где: <br/>
- `Object.assign()` - метод assign глобального объекта Object, который принимает объект курса course с опредённым ID и коппирует все перечислимые свойста course в целевой объект - req.body. <br/>


**4. Сохранение редактируемого курса и перенаправление на страницу "Курсы":** <br/>
Логика сохранения курса после редактирования и перенаправление на страницу "Курсы": <br/>
```node
...
await course.save()
res.redirect('/courses')
...
```
Где: <br/>
- `course.save()` - метод save объекта course сохраняющий данные в базе данных MongoDB. <br/>
- `res.redirect()` - метод redirect объекта ответа response перенаправление на страницу с маршрутом '/courses'. <br/>

⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>

---

#### Метод запроса post по маршруту '/courses/remove'

Код метода запроса post по маршруту '/courses/remove': <br/>
```node
router.post('/remove', auth, async (req, res) => {
  try {
    await Course.deleteOne({
      _id: req.body.id, 
      userId: req.user._id
    })
    res.redirect('/courses')
  } catch (e) {
    console.log(e)
  }
})
```
Где: <br/>
**1. Удаление одного курса из базы данных:** <br/>
Логика удаления одного курса из базы данных: <br/>
```node
await Course.deleteOne({
      _id: req.body.id, 
      userId: req.user._id
    })
```
Где: <br/>
- `Course.deleteOne({})` - метод deleteOne модели Course, который ищет курс по ID у определенного пользователя. Метод принимает 2 аргумента: <br/>
  - `_id` - значение ID курса сравнивающее значение ID курса в получаемом запросе - req.body.id. <br/> 
  - `userId` - значение ID пользователя сравнивающее значение ID пользователя в получаемом запросе - req.user._id. <br/>

**2. Перенаправление на страницу "Курсы":** <br/>
Логика перенаправления на страницу "Курсы": <br/>
```node
router.post('/remove', auth, async (req, res) => {
  ...
  res.redirect('/courses')
  ...
})
```
Где: <br/>
- `res.redirect()` - метод redirect объекта ответа response перенаправление на страницу с маршрутом '/courses'. <br/>

⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>

### Контроллеры страницы "Добавить курс"

**Таблица всех контроллеров страницы "Добавить курс":**
| Метод запроса | URL-путь запроса |                    Функция                  |
| :---------: | :--------------: | :-----------------------------------------: |
|     get     |      "/add"      | Визуализация страницы "Добавить новый курс" |
|     get     |      "/add"      |     Определение флага активности ссылки     |
|     post    |      "/add"      |     Проверка валидатором на пустые поля     | 
|     post    |      "/add"      |            Создание нового курса            | 
|     post    |      "/add"      |    Сохранение нового курса в базе данных    | 

⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>
↩️ [К оглавлению документации](../README.md) <br/>

---

#### Метод запроса get по маршруту '/add'

Код метода запроса get по маршруту '/add': <br/>
```node
router.get('/', auth, (req, res) => {
  res.render('add', {
    title: 'Добавить курс',
    isAdd: true
  })
})
```
Где:<br/>
**1. Визуализация страницы "Добавить курс":** <br/>
Логика передачи данных для последующей визуализации страницы "Добавить курс": <br/>
```node
...
res.render('add', {
    title: 'Добавить курс',
    ...
  })
})
```
Где: <br/>
- `res.render('add', {})` - метод render объекта response, который визуализирует данные приходящие из файла add.hbs.<br/>
- `title` - ключ определяющий значение данных заголовка, который передаётся для шаблонизатора в виде строки 'Добавить курс'. <br/>

**2. Определение флага активности ссылки:** <br/>
Логика определения флага активности ссылки: <br/>
```node
...
  res.render('add', {
    ...
    isAdd: true
  })
...
```
Где: <br/>
- `isAdd` - ключ флага, переключение которого реализовывается boolean типом данных. По умолчанию ключ принимает значение - true. <br/>

⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>

----

#### Метод запроса post по маршруту '/add'

Код запроса post по маршруту '/add': <br/>
```node
router.post('/', auth, courseValidators, async (req, res) => {

  const errors = validationResult(req)
  if (!errors.isEmpty()) {
    return res.status(422).render('add', {
      title: 'Добавить курс',
      isAdd: true,
      error: errors.array()[0].msg,
      data: {
        title: req.body.title,
        price: req.body.price,
        img: req.body.img
      }
    })
  }

  const course = new Course({
    title: req.body.title,
    price: req.body.price,
    img: req.body.img,
    userId: req.user
})
    await course.save()
    res.redirect('/courses')
})
```
Где: <br/>
**1. Проверка валидатором на пустые поля:** <br/>
Логика проверки на пустые поля: <br/>
```node
...
  if (!errors.isEmpty()) {
    ...
  }
...
```
Где: <br/>
- `!errors.isEmpty()` - проверка на пустоту запроса. <br/>

**2. Создание нового курса:** <br/>
Логика создания нового курса: <br/>
```node
...
  const course = new Course({
    title: req.body.title,
    price: req.body.price,
    img: req.body.img,
    userId: req.user
})
...
```
Где: <br/>
- `const course = new Course({})` - новый объект course является экземпляром объекта модели Course, который определяет ряд параметров. <br/>
  - `title` - ключ принимающий значение заголовка req.body.title приходящее в теле запроса req.body. <br/>
  - `price` - ключ принимающий значение цены req.body.price приходящее в теле запроса req.body. <br/>
  - `img` - ключ принимающий значение строки картинки req.body.img приходящее в теле запроса req.body. <br/>
  - `userId` - ключ принимающий значение ID пользователя req.user приходящее в объекте запроса req. <br/>

**3. Сохранение нового курса в базе данных:** <br/>
Логика сохранения курса в базе данных и перенаправлении запроса на страницу "Курсы": <br/>
```node
...
    await course.save()
    res.redirect('/courses')
...
```
Где: <br/>
- `course.save()` - метод save объекта course сохраняющий данные в базе данных MongoDB.<br/>
- `res.redirect()` - метод redirect объекта ответа response перенаправление на страницу с маршрутом '/courses'. <br/>

⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>

### Контроллеры страницы "Профиль"

**Таблица всех контроллеров страницы "Профиль":**
| Метод запроса | URL-путь запроса |                                      Функция                                   |
| :---------: | :--------------: | :----------------------------------------------------------------------------: |
|     get     |    "/profile"    |                         Визуализация страницы "Профиль"                        |
|     get     |    "/profile"    |                       Определение флага активности ссылки                      |
|     get     |    "/profile"    |                        Визуализация данных пользователя                        |
|     post    |    "/profile"    |                            Поиск пользователя по ID                            |
|     post    |    "/profile"    |   Подтягивание всех существующих данных пользователя для его редактирования    |
|     post    |    "/profile"    |                          Редактирование имени пользователя                     |
|     post    |    "/profile"    | Сохранение редактируемого пользователя и перенаправление на страницу "Профиль" |

⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>
↩️ [К оглавлению документации](../README.md) <br/>

---

#### Метод запроса get по маршруту '/profile'

Код запроса get по маршруту '/profile': <br/>
```node
router.get('/', auth, async (req, res) => {
  res.render('profile', {
    title: 'Профиль',
    isProfile: true,
    user: req.user.toObject()
  })
})
```
Где:<br/> 

**1. Визуализация страницы "Профиль":** <br/>
Логика передачи данных для последующей визуализации страницы "Профиль": <br/>
```node
...
res.render('profile', {
  title: 'Профиль',
  ...
}) 
```
Где: <br/>
- `res.render('profile', {})` - метод render объекта response который передаёт данные в шаблон profile.hbs для последующей визуализации данных. <br/>
- `title` - ключ принимающий значение определения заголовка 'Профиль' для последующей визуализации данных шаблонизатором. <br/>

**2. Определение флага активности ссылки:** <br/>
Логика определение флага активности ссылки: <br/>
```node
...
  isProfile: true
...
```
Где: <br/>
- `isProfile` - ключ флага, переключение которого реализовывается boolean типом данных. По умолчанию ключ принимает значение - true. <br/>
  
**3. Визуализация данных пользователя:** <br/>
Логика передачи данных пользователю на последующую визуализацию: <br/>
```node
...
  user: req.user.toObject()
...
```
Где: <br/>
- `user` - ключ принимающий привёденный к объекту под запрос req.user c помощью метода toObject(), который возвращает объект с каждым именем свойства и значения соответствующим записям в коллекции. <br/>
 
⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>

---

#### Метод запроса post по маршруту '/profile'

Код запроса post по маршруту '/profile': <br/>
```node
router.post('/', auth, async (req, res) => {
  try {
    const user = await User.findById(req.user._id)

    const toChange = {
      name: req.body.name
    }

    if (req.file) {
      toChange.avatarUrl = req.file.path
    }

    Object.assign(user, toChange)
    await user.save()
    res.redirect('/profile')
  } catch (e) {
    console.log(e)
  }
})
```
Где: <br/>
**1. Поиск пользователя по ID:** <br/>
Логика поиска пользователя по ID: <br/>
```node
...
const user = await User.findById(req.user._id)
...
```
Где: <br/>
- `User.findById()` - метод findById модели User, который ищет пользователя по запросу req.user._id из коллекции User и возвращает эти данные. <br/>

**2. Подтягивание всех существующих данных пользователя для его редактирования:** <br/>
Логика подтягивания всех существующих данных пользователя для его редактирования: <br/>
```node
...
const user = await User.findById(req.user._id)

const toChange = {
      name: req.body.name
    }
...
Object.assign(user, toChange)
...
```
Где: <br/>
- `User.findById()` - метод findById модели User, который ищет пользователя по входящему запросу с ID req.user._id из коллекции User и возвращает эти данные. <br/>
- `toChange` - объект имеющий ключ name с значением принимаемого запросом имя пользователя req.body.name. <br/>
- `Object.assign()` - метод assign глобального объекта Object, который включает данные документа user, которые подставляются в целевой объект toChangе и который принимает два аргумента:
  - `user` - объект пользователя найденого в базе данных по ID пользователя. <br/>
  - `toChange` - объект, внутри которого определны ряд клюей пользователя в том числе, name, который принимает значение req.body.name. <br/>

**3. Редактирование имени пользователя:** <br/>
Логика редактирования имени пользователя: <br/>
```node
...
    const toChange = {
      name: req.body.name
    }
...
```
Где: <br/>
- `toChange` - объект, внутри которого определны ряд ключей пользователя в том числе, name, который принимает значение req.body.name. <br/>

**4. Сохранение редактируемого пользователя и перенаправление на страницу "Профиль":** <br/>
Логика сохранения редактируемого пользователя и перенаправление на страницу "Профиль": <br/>
```node
    await user.save()
    res.redirect('/profile')
```
Где: <br/>
- `user.save()` - метод save объекта user сохраняющий данные в базе данных MongoDB. <br/>
- `res.redirect()` - метод redirect объекта ответа responsе перенаправление на страницу с маршрутом '/profile'. <br/>

⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>

### Контроллеры страницы "Корзина"

**Таблица всех контроллеров страницы "Корзина":**
| Метод запроса |  URL-путь запроса  |                                Функция                             |
| :---------: | :----------------: | :----------------------------------------------------------------: |
|     get     |      "/card"       |                 Визуализация корзины пользователя                  |
|     get     |      "/card"       |                Определение флага активности ссылки                 |
|     get     |      "/card"       |                    Расчёт стоимости всех курсов                    |
|     get     |      "/card"       |                   Визуализация страницы "Корзина"                  |
|     post    |    "/card/add"     |                         Поиск курса по ID                          |
|     post    |    "/card/add"     | Добавление курса в корзину и перенаправление на страницу "Корзина" |
|    delete   | "/card/remove/:id" |                   Удаление курса по ID из корзины                  |
|    delete   | "/card/remove/:id" |         Пересчёт стоимости всех курсов после удаления курса        |

⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>
↩️ [К оглавлению документации](../README.md) <br/>

---

#### Метод запроса get по маршруту '/card'

Код запроса get по маршруту '/card': <br/>
```node
router.get('/', auth, async (req, res) => {
  const user = await req.user
    .populate('cart.items.courseId')
    .execPopulate()

  const courses = mapCartItems(user.cart)

  res.render('card', {
    title: 'Корзина',
    isCard: true,
    courses: courses,
    price: computePrice(courses)
  })
})
```
Где: <br/>

**1. Визуализация корзины пользователя:** <br/>
Логика отправки данных для последующей визуализации: <br/>
```node
...
const user = await req.user
    .populate('cart.items.courseId')
    .execPopulate()
...
```
Где: <br/>
- `req.user` - запрос на объект пользователя. <br/>
- `populate()` - метод проверяющий, включает ли массив с курсами cart.items.courseId в объект пользователя. <br/>
- `execPopulate()` - функция возвращающая найденные данные. <br/>

**2. Определение флага активности ссылки:** <br/>
Определение флага активности ссылки: <br/>
```node
...
  isCard: true
...
```
Где: <br/>
- `isCard` - ключ флага, переключение которого реализовывается boolean типом данных. По умолчанию ключ принимает значение - true. <br/>

**3. Расчёт стоимости всех курсов:** <br/>
Логика расчёта стоимости всех курсов: <br/>
```node
...
price: computePrice(courses)
...
```
Где: <br/>
- `price` - ключ принимающий результат функции computePrice. <br/>
- `computePrice()` - функция принимающая массив курсов 'courses' для последующего расчёта суммі стоимости всех курсов. <br/>

*Функция computePrice:* <br/>
```node
function computePrice(courses) {
  return courses.reduce((total, course) => {
    return total += course.price * course.count
  }, 0)
}
```
Где: <br/>
- `computePrice(courses) {}` - функция принимающая массив курсов сourses. <br/>
- `courses.reduce(() => {})` - метод reduce есть у каждого массива. Метод позволяет свернуть сумму каждого элемента массива в общую сумму. Метод принимает 2 аргумента. 
  - `total` - аргумент принимающий итоговую сумму. <br/>
  - `сourse` - аргумент принимающий объект одного курса или одного элемента массива. <br/>
- `total += course.price * course.count` - выражение вычисляющее итоговую сумму с расчёта количество определенного курса умноженное на стоимость этого курса. <br/>
  - `course.price` - цена курса. <br/>
  - `course.count` - количество курсов покупаемых пользователем. <br/>

**4. Визуализация страницы "Корзина":** <br/>
Логика передачи данных для последующей визуализации страницы "Корзина": <br/>
```node
res.render('card', {
  title: 'Корзина',
  ...
  }) 
```
Где: <br/>
- `res.render('card', {})` - метод render объекта response, который визуализирует данные приходящие из файла card.hbs. <br/>
- `title` - ключ определяющий значение данных заголовка, который передаётся для шаблонизатора в виде строки 'Корзина'. <br/>

⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>

#### Метод запроса post по маршруту '/card/add'

---

Кода запроса post по маршруту '/card/add': <br/>
```node
router.post('/add', auth, async (req, res) => {
  const course = await Course.findById(req.body.id)
  await req.user.addToCart(course)
  res.redirect('/card')
})
```
Где: <br/>

**1. Поиск курса по ID:** <br/>
Логика поиска курса по ID: <br/>
```node
...
const course = await Course.findById(req.body.id)
...
```
Где: <br/>
- `Course.findById()` - метод findById модели Course, который ищет курс по входящему запросу с ID req.body.id из коллекции Course и возвращает эти данные. <br/>

**2. Добавление курса в корзину и перенаправление на страницу "Корзина":** <br/>
Логика добавления курса в корзину и перенаправление на страницу "Корзина": <br/>
```node
...
await req.user.addToCart(course)
res.redirect('/card')
...
```
Где: <br/>
- `req.user.addToCart()` - функция модели User - addToCart принимающая аргумент - course. Код функции указан ниже. <br/>
- `res.redirect()` - метод redirect объекта ответа response перенаправление на страницу с маршрутом '/card'. <br/>

*Функция addToCart:* <br/>
```node
userSchema.methods.addToCart = function(course) {
  const items = [...this.cart.items]
  const idx = items.findIndex(c => {
    return c.courseId.toString() === course._id.toString()
  })

  if (idx >= 0) {
    items[idx].count = items[idx].count + 1
  } else {
    items.push({
      courseId: course._id,
      count: 1
    })
  }

  this.cart = {items}
  return this.save()
}
```
Где: <br/>
- `userSchema.methods.addToCart` - метод methods, который есть у каждой схемы Schema в том числе и userSchema позволяющий создать метод для конкретной схемы. Название метода указывается после точки: .addToCart. <br/>
- `function(course) {}` - функция принимающая объект курса course. <br/>
- `const items = [...this.cart.items]` - метод spread ... результатом которого является развёртывание всех данных из массива items вложенного в объект cart, который передаётся контекстом this, где this это получаемый функцией курс course. <br/>
- `const idx = items.findIndex(c => {})` - метод findIndeх возвращает индексированый элемент массива после чего обрабатывает его в теле функции. <br/>
- `return c.courseId.toString() === course._id.toString()` - возвращает значение ID приведенного к строке course._id.toString() и приводит строгое сравнение с ID курсом запроса c.courseId.toString(). <br/>
- `if (idx >= 0) {}` - условие, которое выполняется, если элемент больше или равен 0.<br/>
- `items[idx].count = items[idx].count + 1` - элемент по индексу idx, который увеличивается на 1 количество определенного курса в массиве items. <br/>
- `items.push({})` -  метод push добавляющий вконец списка тело объекта, состоящие из 2 ключей: courseId и count. <br/>
- `courseId` - ключ принимающий значение ID course._id. ID с нижним подчёркиванием _id является уникальными идентификаторами в базе данных MongoDB. <br/>
- `count` - ключ принимающий значение количества одного курса в количестве - 1. <br/>
- `this.cart` - ключ переопределяющий значение объекта {items}, как новый объект контекста корзины, где this.cart является аналогичным записи course.cart. <br/>
- `return this.save()` -  метод save сохроняет состояние корзины в базе данных у модели User, а именно оновленный массив в поле cart = [] модели User после чего return возвращает сохранённое значение как результат выполнения функции. 

⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>

---

#### Метод запроса delete по маршруту '/card/remove/:id'

Код метода запроса delete по маршруту '/card/remove/:id': <br/>
```node
router.delete('/remove/:id', auth, async (req, res) => {
  await req.user.removeFromCart(req.params.id)
  const user = await req.user.populate('cart.items.courseId').execPopulate()
  const courses = mapCartItems(user.cart)
  const cart = {
    courses, price: computePrice(courses)
  }
  res.status(200).json(cart)
})
```
где: <br/>

**1. Удаление курса по ID из корзины:** <br/>
Логика удаления курса по ID из корзины: <br/>
```node
...
await req.user.removeFromCart(req.params.id)
...
```
Где: <br/>
- `req.user.removeFromCart()` -  функция модели User - removeFromCart принимающая аргумент - req.params.id и результат которой это удаление курса по ID, который приходит в запросе. Код функции указан ниже: <br/>

*Код функции `removeFromCart()`* <br/>
```node
userSchema.methods.removeFromCart = function(id) {
  let items = [...this.cart.items]
  const idx = items.findIndex(c => c.courseId.toString() === id.toString())

  if (items[idx].count === 1) {
    items = items.filter(c => c.courseId.toString() !== id.toString())
  } else {
    items[idx].count--
  }

  this.cart = {items}
  return this.save()
}

userSchema.methods.clearCart = function() {
  this.cart = {items: []}
  return this.save()
}
```
Где: <br/>
- `userSchema.methods.removeFromCart` - метод `methods`, который есть у каждой схемы `Schema` в том числе и `userSchema` позволяющий создать метод для конкретной схемы. Название метода указывается после точки: `.removeFromCart`. <br/>
- `function()` - функция принимающая ID запроса `req.user.id`, который принимается аргументов `id` функции. <br/>
- `let items = [...this.cart.items]` - метод spread `...` результатом которого является развёртывание всех данных из массива `items` вложенного в объект `cart`, который передаётся контекстом `this`, где `this` это получаемый функцией курс `course`. <br/>
- `const idx = items.findIndex(c => c.courseId.toString() === id.toString())` - возвращает индексируемый єлемент массива после чего сравнивает приведенный к строке ID объекта `с` и сравнивает строгим сравнением с ID запроса `request`, который также приводится к строке. Уникальный ID является и так строкой, но во избежания ошибок, принимается явное преобразование ID в строку. <br/>
- `if (items[idx].count === 1) {}` - условие при котором индексированный элемент `idx` в массиве `items` находится в количестве 1, то выполнится тело условия. <br/>
- `items = items.filter(c => c.courseId.toString() !== id.toString())` - метод `filter` перебирает элементы массива `c` и создаёт новый массив в который отбирает те элементы `c`, где ID курса не равняется ID курса находиящийся в запросе `req.user.id`.
- `items[idx].count--` - производит декремент (уменьшает значение на 1) у свойства `count` элемента `idx` массива `items`. <br/>
- `this.cart` - ключ переопределяющий значение объекта `{items}`, как новый объект контекста корзины, где `this.cart` является аналогичным записи `course.cart`. <br/>
- `return this.save()` -  метод `save` сохроняет состояние корзины в базе данных у модели `User`, а именно оновленный массив в поле `cart = []` модели `User` после чего `return` возвращает сохранённое значение как результат выполнения функции. 

**2. Вывод всех курсов:** <br/>
Логика вывода всех курсов: <br/>
```node 
...
const courses = mapCartItems(user.cart)
const cart = {
    courses, price: computePrice(courses)
  }
  res.status(200).json(cart)
...
```
Где: <br/>
- `mapCartItems()` - функция модели User - mapCartItems принимающая аргумент корзины пользователя - user.cart. Код функции указан ниже. <br/>
- `cart` - объект корзины пользователя.<br/>
  - `courses` - ключ с одноименным значением массива курсов curses. <br/>
  - `price` - ключ принимающий значение результата выполнения функции computePrice, которая принимает значение courses. Логика кода с подробным объяснением функции смотрите [Метод запроса get по маршруту '/card'](#метод-запроса-get-по-маршруту-card). <br/>
- `res.status(200).json(cart)` - метод status объекта response принимающий значение кода отправки сервера 200 и объект корзины cart преобразованной в формат json. <br/>

*Функция mapCartItems:* <br/>
```node
function mapCartItems(cart) {
  return cart.items.map(c => ({
    ...c.courseId._doc, 
    id: c.courseId.id,
    count: c.count
  }))
}
```
Где: <br/>
- `mapCartItems(cart) {}` - функция  mapCartItems принимающая как аргумент объект корзины cart после чего выполняет тело функции. <br/>
- `return cart.items.map(c => ({})` - возвращает результат разворачивание массива items объекта корзины cart. Метод map разворарачивает каждый элемент c массива items после чего выполняет тело метода. <br/>
- `...c.courseId._doc` - метод spread ... результатом которого является развёртывание у элемента c значение courseId._doc. <br/>
- `id` - ключ принимающий значение ID курса c.courseId.id. <br/>
- `count` - ключ количества принимающий значение количества элемента c - c.count. <br/>

⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>

### Контроллеры страницы "Заказы"

**Таблица всех контроллеров страницы "Заказы":**
| Метод запроса | URL-путь запроса |                           Функция                        |
| :---------: | :--------------: | :------------------------------------------------------: |
|     get     |     "/orders"    |             Поиск заказов пользователя по ID             |
|     get     |     "/orders"    |              Визуализация страницы "Заказы"              |
|     get     |     "/orders"    |               Подсчёт стоимости всех курсов              |
|     post    |     "/orders"    |           Формирование заказа для пользователя           |
|     post    |     "/orders"    |   Вывод каждого курса и количества единиц каждого курс   |
|     post    |     "/orders"    |                Формирование нового заказа                |
|     post    |     "/orders"    |                     Сохранение заказа                    |
|     post    |     "/orders"    | Очищение корзины и перенаправление на страницу "Заказы"  |

⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>
↩️ [К оглавлению документации](../README.md) <br/>

---

#### Метод запроса get по маршруту '/orders'

Код метода запроса get по маршруту '/orders': <br/>
```node
router.get('/', auth, async (req, res) => {
  try {
    const orders = await Order.find({'user.userId': req.user._id})
      .populate('user.userId')

    res.render('orders', {
      isOrder: true,
      title: 'Заказы',
      orders: orders.map(o => {
        return {
          ...o._doc,
          price: o.courses.reduce((total, c) => {
            return total += c.count * c.course.price
          }, 0)
        }
      })
    })
  } catch (e) {
    console.log(e)
  }
})
```
Где: <br/>
**1. Поиск заказов пользователя по ID:** <br/>
Логика поиска заказов пользователя по ID: <br/>
```node
...
const orders = await Order.find({'user.userId': req.user._id})
      .populate('user.userId')
...
```
Где: <br/>
- `Order.find({})` - метод find модели Order, который находит данные, в которых ID 'user.userId' является таким же как ID запроса req.user._id. <br/>
    - `user.userId` - ID пользователя, который есть в базе данных MongoDB. <br/>
    - `req.user._id` - ID запроса, который приходит с объектом запроса request. <br/>
- `populate()` - метод проверяющий, включение user.userId в результат. <br/>

**2. Визуализация страницы "Заказы":** <br/>
Логика передачи данных для последующей визуализации страницы "Заказы": <br/>
```node
...
res.render('orders', {
  ...
  title: 'Заказы'
  ...
})
```
Где: <br/>
- `res.render('orders', {})` - метод render объекта response, который визуализирует данные приходящие из файла orders.hbs. <br/>
- `title` - ключ определяющий значение данных заголовка, который передаётся для шаблонизатора в виде строки 'Заказы'.<br/>

**3. Подсчёт стоимости всех курсов:** <br/>
Логика подсчёта стоимости всех курсов: <br/>
```node
orders: orders.map(o => {
        return {
          ...o._doc,
          price: o.courses.reduce((total, c) => {
            return total += c.count * c.course.price
          }, 0)
        }
      })
```
Где: <br/>
- `orders: orders.map(o => {})` - ключ принимающий значение результата метода map выражения orders.map(o => {}). Метод возвращает результат разворачивание массива o объекта заказы orders после чего выполняет тело метода. <br/>
- `...o._doc` - метод spread ... результатом которого является развёртывание у элемента o в виде простого объекта. <br/>
- `o.courses.reduce((total, c) => {})` - метод reduce есть у каждого массива. Метод позволяет свернуть сумму каждого элемента массива в общую сумму. <br/>
- `return total += c.count * c.course.price` - выражение вычисляющее итоговую сумму с расчёта количество определенного курса умноженное на стоимость этого курса. <br/>
  - `c.price` - цена курса. <br/>
  - `c.count` - количество курсов покупаемых пользователем. <br/>


⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>

---

#### Метод запроса post по маршруту '/orders'

Код метода запроса post по маршруту '/orders': <br/>
```node
router.post('/', auth, async (req, res) => {
  try {
    const user = await req.user
      .populate('cart.items.courseId')
      .execPopulate()

    const courses = user.cart.items.map(i => ({
      count: i.count,
      course: {...i.courseId._doc}
    }))

    const order = new Order({
      user: {
        name: req.user.name,
        userId: req.user
      },
      courses: courses
    })

    await order.save()
    await req.user.clearCart()

    res.redirect('/orders')
  } catch (e) {
    console.log(e)
  }
})
```
Где: <br/>

**1. Формирование заказа для пользователя:** <br/>
Логика формирования заказа для пользователя: <br/>
```node
...
    const user = await req.user
      .populate('cart.items.courseId')
      .execPopulate()
...
``` 
Где: <br/>
- `req.user` - запрос на объект пользователя. <br/>
- `populate()` - метод проверяющий, включает ли массив с курсами cart.items.courseId в объект пользователя. <br/>
- `execPopulate()` - функция возвращающая найденные данные. <br/>

**2. Вывод каждого курса и количества единиц каждого курса:** <br/>
Логика вывода каждого курса и количества единиц каждого курса: <br/>
```node
...
    const courses = user.cart.items.map(i => ({
      count: i.count,
      course: {...i.courseId._doc}
    }))
...
```
Где: <br/>
- `user.cart.items.map(i => ({})` - метод map разворачивающий каждый элемент i массива items, который входит в объект cart модели user. <br/>
- `count` - ключ принимающий значение количества единиц курса i.count. <br/>
- `course` - ключ принимающий значение результата развёртывание элемента i из выражение {...i.courseId._doc}, где метод spread ... разворачивает простой объект со свойством courseId без обёрток mongoose. <br/>

**3. Формирование нового заказа:** <br/>
Логика формирования нового заказа: <br/>
```node
...
    const order = new Order({
      user: {
        name: req.user.name,
        userId: req.user
      },
      courses: courses
    })
...
```
Где: <br/>
- `order = new Order({})` - order экземпляр объекта Order, в тело которого включены все свойства объекта Order. <br/>
- `user: {}` - объект пользователя входящий в объект заказа Order. <br/>
  - `name` - ключ принимающий значение запроса имени пользователя req.user.name. <br/>  
  - `userId` - ключ принимающий значение запроса ID пользователя req.user. <br/>
- `courses` - ключ принимающий одноименный массив курсов courses. <br/>

**4. Сохранение заказа:** <br/>
Код, отвечающий за сохранение заказа: <br/>
```node
...
    await order.save()
...
```
Где: <br/>
- `order.save()` - метод save объекта order сохраняющий данные в базе данных MongoDB. <br/>

**5. Очищение корзины и перенаправление на страницу "Заказы":** <br/>
Код, отвечающий за очищение корзины и перенаправление на страницу "Заказы": <br/>
```node
...
    await req.user.clearCart()
    res.redirect('/orders')
...
```
Где: <br/>
- `req.user.clearCart()` - функция модели User - clearCart. Код функции указан ниже. <br/>
- `res.redirect()` - метод redirect объекта ответа response перенаправление на страницу с маршрутом '/orders'. <br/>

*Функция clearCart:* <br/>
```node
userSchema.methods.clearCart = function() {
  this.cart = {items: []}
  return this.save()
}
```
Где: <br/>
- `userSchema.methods.clearCart` - метод methods, который есть у каждой схемы Schema в том числе и userSchema позволяющий создать метод для конкретной схемы. Название метода указывается после точки: .clearCart. <br/>
- `function() {}` - функция не принимающая никаких аргументов. <br/>
- `this.cart` - {items: []} переопределение массива items пустого значение массива в объекте this.cart, где this.cart аналогично user.cart. <br/>
- `return this.save()` - возврат сохранённого результата в базе данных MongoDB массива cart модели user. <br/>


⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>

### Контроллеры страницы "Вход / Выход"

Таблица всех контроллеров страницы "Вход / Выход":
| Метод запроса |    URL-путь запроса     |                                           Функция                                         |
| :---------: | :---------------------: | :---------------------------------------------------------------------------------------: |
|     get     |      "/auth/login"      |                               Визуализация страницы "Вход"                                |
|     get     |      "/auth/login"      |                            Определение флага активности ссылки                            |
|     get     |      "/auth/login"      |                        Проверка на подлинность логика пользователя                        |
|     get     |      "/auth/login"      |                        Проверка на подлинность пароль пользователя                        |
|     get     |      "/auth/loguot"     |           Уничтожение сессии пользователя и перенаправление на страницу "Вход"            |
|     get     |       "/auth/reset"     |                            Визуализация страницы "Смена пароля"                           |
|     get     |       "/auth/reset"     |                  Вывод ошибки в случае если пользователя не в базе данных                 |
|     get     | "/auth/password/:token" |                         Проверка на действенный токен пользователя                        |
|     get     | "/auth/password/:token" |                       Поиск пользователя по действительному токену                        |
|     get     | "/auth/password/:token" |                     Проверка на существование уникально пользователя                      |
|     get     | "/auth/password/:token" |                         Визуализация страницы "Восстановить доступ"                       |
|     get     | "/auth/password/:token" |                Проверка на восстановление доступа конкретному пользователю                |
|     post    |       "/auth/login"     |                      Проверка данных пользователя для входа в аккаунт                     |
|     post    |       "/auth/login"     |              Получение пользователем авторизированных прав и открытие сессии              |
|     post    |       "/auth/login"     |                              Проверка на правильность пароля                              |
|     post    |      "/auth/register"   |           Создание аккаунта нового пользователя и шифрование пароля пользователя          |
|     post    |      "/auth/register"   |                       Сохранение данных пользователя в базе данных                        |
|     post    |      "/auth/register"   |                   Отправка письма пользователю об успешной регистрации                    |
|     post    |       "/auth/reset"     |                            Поиск пользователю в базе данных                               |
|     post    |       "/auth/reset"     |                           Формирование токена пользователя                                |
|     post    |       "/auth/reset"     |          Отправка сообщения с новым токеном на почту существующему пользователю           |
|     post    |     "/auth/password"    |                                 Поиск пользователя по ID                                  |
|     post    |     "/auth/password"    | Сохранение нового пароля пользователя в базе данных и перенаправление на страницу "Логин" |
|     post    |     "/auth/password"    |                               Проверка на срок жизни токена                               |


⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>
↩️ [К оглавлению документации](../README.md) <br/>

#### Метод запроса get по маршруту '/auth/login'

---

Код метода запроса get по маршруту '/auth/login': <br/>
```node
router.get('/login', async (req, res) => {
  res.render('auth/login', {
    title: 'Авторизация',
    isLogin: true,
    loginError: req.flash('loginError'),
    registerError: req.flash('registerError')
  })
})
```
Где: <br/>
**1. Визуализация страницы "Вход":** <br/>
Логика передачи данных для последующей визуализации страницы "Вход": <br/>
```node
...
res.render('auth/login', {
    title: 'Авторизация',
    ...
})
```
Где: <br/>
- `res.render('auth/login', {})` - метод render объекта response, который визуализирует данные приходящие из файла login.hbs, который находится в папке auth. <br/> 
- `title` - ключ определяющий значение данных заголовка, который передаётся для шаблонизатора в виде строки 'Авторизация'. <br/>

**2. Определение флага активности ссылки:** <br/>
Логика определения флага активности ссылки: <br/>
```node
...
  isLogin: true,
...
```
Где: <br/>
- `isLogin` - ключ флага, переключение которого реализовывается boolean типом данных. По умолчанию ключ принимает значение - true. <br/>

**3. Проверка на подлинность логина пользователя:** <br/>
Логика проверки на подлинность логина пользователя: <br/>
```node
...
  loginError: req.flash('loginError'),
...
```
Где: <br/>
- `loginError` -  ключ передающий результат функции req.flash('loginError'), в случае, если происходит ошибка валидации в представлении - выводится ошибка 'loginError'. <br/>
- `req.flash()` - функция выводящая информацию для пользователя принимающая аргмуент 'loginError', который отображает текст валидирующей ошибки.<br/>

**4. Проверка на подлинность пароль пользователя:** <br/>
Логика проверки на подлинность пароля пользователя: <br/>
```node
...
  registerError: req.flash('registerError'),
...
```
Где: <br/>
- `registerError` -  ключ передающий результат функции req.flash('registerError'), в случае, если происходит ошибка валидации в представлении - выводится ошибка 'registerError'. <br/>
- `req.flash()` - функция выводящая информацию для пользователя принимающая аргумент 'registerError', в которой отображается текст валидирующей ошибки. <br/>

⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>

---

#### Метод запроса get по маршруту '/auth/loguot'

Код метода запроса get по маршруту '/auth/loguot': <br/>
```node
router.get('/logout', async (req, res) => {
  req.session.destroy(() => {
    res.redirect('/auth/login#login')
  })
})
```
Где: <br/>

**1. Уничтожение сессии пользователя и перенаправление на страницу "Вход":** <br/>
Логика уничтожения сессии пользователя и перенаправление на страницу "Вход": <br/>
```node
...
  req.session.destroy(() => {
    res.redirect('/auth/login#login')
...
})
```
Где: <br/>
- `req.session.destroy(() => {})` - функция удаляющая из состояния приложения сессии пользователя, после чего выполняет тело функции. <br/>
- `res.redirect()` - метод redirect объекта ответа response перенаправление на страницу с маршрутом '/auth/login#login'. <br/>

---

#### Метод запроса get по маршруту '/auth/reset'

Код метода запроса get по маршруту '/auth/reset': <br/>
```node
router.get('/reset', (req, res) => {
  res.render('auth/reset', {
    title: 'Забыли пароль?',
    error: req.flash('error')
  })
})
```
Где: <br/>

**1. Визуализация страницы "Смена пароля":** <br/>
Логика передачи данных для последующей визуализации страницы "Смена пароля": <br/>
```node
...
res.render('auth/reset', {
  title: 'Забыли пароль?'
  ...
})
```
Где: <br/>
- `res.render('auth/reset', {}` - метод render объекта response, который визуализирует данные приходящие из файла reset.hbs, который находится в папке auth. <br/> 
- `title` -  ключ определяющий значение данных заголовка, который передаётся для шаблонизатора в виде строки  'Забыли пароль?'. <br/>

**2. Вывод ошибки в случае если пользователя не в базе данных:** <br/>
Логика вывода ошибки, в случае если пользователя нет в базе данных: <br/>
```node
...
  error: req.flash('error')
...
```
Где: <br/>
- `error` - ключ принимающий значение результата функции ошибки req.flash('error'). <br/>
- `req.flash()` -  функция выводящая информацию для пользователя принимающая аргумент 'error', в которой отображается текст валидирующей ошибки. <br/>

⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>

---

#### Метод запроса get по маршруту '/auth/password/:token'

Код метода запроса get по маршруту '/auth/password/:token': <br/>
```node
router.get('/password/:token', async (req, res) => {
  if (!req.params.token) {
    return res.redirect('/auth/login')
  }

  try {
    const user = await User.findOne({
      resetToken: req.params.token,
      resetTokenExp: {$gt: Date.now()}
    })

    if (!user) {
      return res.redirect('/auth/login')
    } else {
      res.render('auth/password', {
        title: 'Восстановить доступ',
        error: req.flash('error'),
        userId: user._id.toString(),
        token: req.params.token
      })
    }
  } catch (e) {
    console.log(e)
  }
  
})
```
Где: <br/>
**1. Проверка действенного токена пользователя:** <br/>
Логика проверки действенного токен пользователя: <br/>
```node
...
  if (!req.params.token) {
    return res.redirect('/auth/login')
  }
...
```
Где: <br/>
- `if (!req.params.token) {}` - проверка на предмет если с телом запроса request не приходит токен, то выполнить тело функции. <br/>
- `return res.redirect()` - метод redirect объекта ответа response перенаправление на страницу с маршрутом '/auth/login'. <br/>

**2. Поиск пользователя по действительному токену:** <br/>
Логика поиска пользователя по действительному токену: <br/>
```node 
  try {
    const user = await User.findOne({
      resetToken: req.params.token,
      resetTokenExp: {$gt: Date.now()}
    })
```
Где: <br/>
- `User.findOne({})` - метод findOne модели User, который ищет первый объект который подпадает под выполнение условий, заложених в тело метода. <br/>
- `resetToken` - ключ-условие, которое заложено в тело метода и которое сравнивает resetToken с токеном req.params.token, который приходит с телом запроса request.  <br/>
- `resetTokenExp` - ключ-условие, которое заложено в тело метода и которое сравнивает с помощью оператора $gt не привышает ли срок токена больше, чем время в которое выполняется запрос `{Date.now()}`. <br/>

**3. Проверка на существование уникального пользователя:** <br/>
Логика проверки уникального пользователя: <br/>
```node
...
    if (!user) {
      return res.redirect('/auth/login')
    ...
```
Где: <br/>
- `user` - объект пользователя. <br/>
- `return res.redirect()` - метод redirect объекта ответа response перенаправление на страницу с маршрутом '/auth/login'. <br/>

**4. Визуализация страницы "Восстановить доступ":** <br/>
Логика передачи данных для последующей визуализации страницы "Восстановить доступ": <br/>
```node
...
res.render('auth/password', {
        title: 'Восстановить доступ'
        ...   
})
```
Где: <br/>
- `res.render('auth/password', {})` - метод render объекта response, который визуализирует данные приходящие из файла password.hbs, который находится в папке auth. <br/> 
- `title` - ключ определяющий значение данных заголовка, который передаётся для шаблонизатора в виде строки 'Восстановить доступ'. <br/>

**5. Проверка на восстановление доступа конкретному пользователю:** <br/>

Логика восстановления доступа конкретному пользователю: <br/>
```node
...
    error: req.flash('error'),
    userId: user._id.toString(),
    token: req.params.token
    ...
```
Где: <br/>
- `error` - ключ принимающий значение результата функции ошибки req.flash('error'). <br/>
- `req.flash()` - функция выводящая информацию для пользователя принимающая аргумент 'error', в которой отображается текст валидирующей ошибки. <br/>
- `userId` - ключ принимающий значение ID пользователя user._id.toString() приведенного к строке. <br/>
- `token` - ключ принимающий значение токена req.params.token, который приходит с телом запроса. <br/>

⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>

---

#### Метод запроса post по маршруту '/auth/login'

Код метода запроса post по маршруту '/auth/login': <br/>
```node
router.post('/login', async (req, res) => {
  try {
    const {email, password} = req.body
    const candidate = await User.findOne({ email })

    if (candidate) {
      const areSame = await bcrypt.compare(password, candidate.password)

      if (areSame) {
        req.session.user = candidate
        req.session.isAuthenticated = true
        req.session.save(err => {
          if (err) {
            throw err
          }
          res.redirect('/')
        })
      } else {
        req.flash('loginError', 'Неверный пароль')
        res.redirect('/auth/login#login')
      }
    } else {
      req.flash('loginError', 'Такого пользователя не существует')
      res.redirect('/auth/login#login')
    }
  } catch (e) {
    console.log(e)
  }
})
```
Где: <br/>
**1. Проверка данных пользователя для входа в аккаунт:** <br/>
Логика проверки данных пользователя для входа в аккаунт: <br/>
```node
...
const candidate = await User.findOne({ email })

  if (candidate) {
        const areSame = await bcrypt.compare(password, candidate.password)
        ...
  else {
        req.flash('loginError', 'Такого пользователя не существует')
        res.redirect('/auth/login#login')
  }
...
```
Где: <br/>
- `User.findOne({ email })` - метод findOne модели User, который ищет первый объект по значению одноименного ключа email. <br/>
- `bcrypt.compare(password, candidate.password)` - метод compare библиотеки bcrypt, который проверяет пароль пользователя с паролем пользователя полученного запросом от базы данных `MongoDB`. <br/>
  - `password` - пароль пользователя введённый через представление. <br/>
  - `candidate.password` - пароль пользователя полученный из базы данных. <br/>
- `req.flash('loginError', 'Такого пользователя не существует')` - метод flash приходящий с телом запроса request, который принимает два аргумента. <br/>
  - `loginError` - аргумент определяющий название ошибки. <br/>
  - `Такого пользователя не существует` - аргумент строкового текста, который выводится в случае ошибки loginError. <br/>
- `res.redirect()` - метод redirect объекта ответа response перенаправление на страницу с маршрутом '/auth/login#login'. <br/>

**2. Получение пользователем авторизированных прав и открытие сессии:** <br/>
Логика получения пользователем авторизированных прав и открытие сессии: <br/>
```node
...
    if (areSame) {
        req.session.user = candidate
        req.session.isAuthenticated = true
        req.session.save(err => {
          if (err) {
            throw err
          }
          res.redirect('/')
        })
...
```
Где: <br/>
- `if (areSame) {}` - если сравнение введёного пароля и пароля полученного из базы данных даёт true, то выполняется тело объекта. <br/>
- `req.session.user` - свойство пользователя user в обЪекте сессии session, которой присваиваются данные авторизированного пользователя candidate. <br/>
- `req.session.isAuthenticated` - свойство авторизации isAuthenticated, объекта сессии session, которое принимает boolean значение true, что определяет активность сессии. <br/>
- `req.session.save(err => {})` - функция save сохраняющая состояние сессии session. <br/>
- `if (err) {}` - в случае ошибки вывести ошибку throw err. <br/>
- `res.redirect()` - метод redirect объекта ответа response перенаправление на страницу с маршрутом '/'. <br/>


**3. Проверка на правильность пароля:** <br/>
Логика проверки правильности пароля: <br/>
```node
...
req.flash('loginError', 'Неверный пароль')
        res.redirect('/auth/login#login')
      }
    } 
```
Где: <br/>
- `req.flash('loginError', 'Неверный пароль')` - метод flash приходящий с телом запроса request, который принимает два аргумента. <br/>
  - `loginError` - аргумент определяющий название ошибки. <br/>
  - `Неверный пароль` - аргумент строкового текста, который выводится в случае ошибки loginError. <br/>
- `res.redirect()` - метод redirect объекта ответа response перенаправление на страницу с маршрутом '/auth/login#login'. <br/>

⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>

---

#### Метод запроса post по маршруту '/auth/register'

Код метода запроса post по маршруту '/auth/register': <br/>
```node
router.post('/register', registerValidators, async (req, res) => {
  try {
    const {email, password, name} = req.body
    
    const errors = validationResult(req)
    if (!errors.isEmpty()) {
      req.flash('registerError', errors.array()[0].msg)
      return res.status(422).redirect('/auth/login#register')
    }
      const hashPassword = await bcrypt.hash(password, 10)
      const user = new User({
        email, name, password: hashPassword, cart: {items: []}
      })
      await user.save()
      await transporter.sendMail(regEmail(email))
      res.redirect('/auth/login#login')
  } catch (e) {
    console.log(e)
  }
})
```

**1. Проверка вводимых данных валидатором:** <br/>
Логика проверки вводимых данных валидатором: <br/>
```node
...
if (!errors.isEmpty()) {
      req.flash('registerError', errors.array()[0].msg)
      return res.status(422).redirect('/auth/login#register')
    }
...
```
Где: <br/>
- `!errors.isEmpty()` - проверка на пустоту запроса. <br/>  
- `req.flash('registerError', errors.array()[0].msg)` - метод flash приходящий с телом запроса request, который принимает два аргумента. <br/>
  - `registerError` - аргумент определяющий название ошибки. <br/>
  - `errors.array()[0].msg` - аргумент выводящий сообщение ошибки msg, которое находится в первом элементе массива ошибок errors. <br/>
- `res.status(422)` - метод status, объекта response, который принимает код http запроса - 422. <br/>
- `redirect()` - метод redirect объекта ответа response перенаправление на страницу с маршрутом '/auth/login#register'. <br/>


**2. Создание акаунта нового пользователя и шифрование пароля пользователя:** <br/>
Логика создания акаунта нового пользователя и последующее шифрование пароля пользователя: <br/>
```node
...
    const user = new User({
        email, name, password: hashPassword, cart: {items: []}
      })
...
```
Где: <br/>
- `const user = new User({})` - создание нового экземпляра объекта User, которому присваиваются свойства указаны в теле экземпляра объекта. <br/>
- `email, name, password: hashPassword, cart: {items: []}` - перечень как одноименных свойств ключ-значение(к примеру email) так и разноименных password: hashPassword. <br/>

**3. Сохранение данных пользователя в базе данных:** <br/>
Логика сохранения данных пользователя в базе данных: <br/>
```node
...
  await user.save()
...
```
Где: <br/>
- `user.save()` - метод save объекта course сохраняющий данные в базе данных MongoDB. <br/>

**4. Отправка письма пользователю об успешной регистрации:** <br/>
Логика отправки письма пользователю об успешной регистрации: <br/>
```node
...
      transporter.sendMail(regEmail(email))
...
```
Где: <br/>
- `transporter` - переменная подключения, которая выполняет код подключение к сервису sendGrid. Код подключения указан ниже: <br/>
- `sendMail()` - объект отправки писем , который отправляет письмо regMail об успешной регистрации на почту пользователю email. <br/>

⬅️ Подробнее о промежуточном обработчике отправки писем смотрите [nodemailer-sendgrid-transport](middleware.md#nodemailer-sendgrid-transport). <br/>
⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>

---

#### Метод запроса post по маршруту '/auth/reset'

Код метода запроса post по маршруту '/auth/reset': <br/>
```node

const candidate = await User.findOne({email: req.body.email})

router.post('/reset', (req, res) => {
  try {
    crypto.randomBytes(32, async (err, buffer) => {
      if (err) {
        req.flash('error', 'Что-то пошло не так, повторите попытку позже')
        return res.redirect('/auth/reset')
      }

      const token = buffer.toString('hex')
      const candidate = await User.findOne({email: req.body.email})

      if (candidate) {
        candidate.resetToken = token
        candidate.resetTokenExp = Date.now() + 60 * 60 * 1000
        await candidate.save()
        await transporter.sendMail(resetEmail(candidate.email, token))
        res.redirect('/auth/login')
      } else {
        req.flash('error', 'Такого email нет')
        res.redirect('/auth/reset')
      }
    })
  } catch (e) {
    console.log(e)
  }
})
```
Где: <br/>
**1. Поиск пользователя в базе данных:** <br/>
Логика поиска пользователя в базе данных: <br/>
```node
const candidate = await User.findOne({email: req.body.email})
...
```
Где: <br/>
- `User.findOne({email: req.body.email})` - метод findOne модели User, который сравнивает почту пользвателя email с почтой отправленой в теле запроса req.body.email. <br/>

**2. Формирование токена пользователя:** <br/>
Логика формирования токена пользователя: <br/>
```node
...
const token = buffer.toString('hex')
...
if (candidate) { 
        candidate.resetToken = token
        candidate.resetTokenExp = Date.now() + 60 * 60 * 1000
        await candidate.save()
        ...
      } else {
        req.flash('error', 'Такого email нет')
        res.redirect('/auth/reset')
```
Где: <br/>
- `candidate` - объект пользователя найденный методом findOne из модели User. <br/> 
- `candidate.resetToken` - присвание свойству resetTokent объекта candidate значение временного токена token. <br/>
- `candidate.resetTokenExp` - присвание свойству resetTokenExp объекта candidate значение срока жизни токена - Date.now() + 60 * 60 * 1000. <br/>
- `candidate.save()` - метод save сохраняющий объект пользователя candidate в базе данных. <br/>
- `req.flash('error', 'Такого email нет')` - метод flash приходящий с телом запроса request, который принимает два аргумента. <br/>
  - `'error'` - аргумент определяющий название ошибки. <br/>
  - `'Такого email нет'` - аргумент строкового текста, который выводится в случае ошибки error. <br/>

**3. Отправка сообщения с новым токеном на почту существующему пользователю:** <br/>
Логика отправки сообщения с новым токеном на почту существующему пользователю: <br/>
```node
...
    transporter.sendMail(resetEmail(candidate.email, token))
...
```
Где: <br/>
- `transporter` - переменная подключения, которая выполняет код подключение к сервису `sendGrid`. 

⬅️ Подробнее о промежуточном обработчике отправки писем смотрите [nodemailer-sendgrid-transport](middleware.md#nodemailer-sendgrid-transport). <br/>
⬆️ [К оглавлению раздела](#оглавление-раздела) <br/>

---

#### Метод запроса post по маршруту '/auth/password'

Код метода запроса post по маршруту '/auth/password': <br/>
```node
router.post('/password', async (req, res) => {
  try {
    const user = await User.findOne({
      _id: req.body.userId,
      resetToken: req.body.token,
      resetTokenExp: {$gt: Date.now()}
    })

    if (user) {
      user.password = await bcrypt.hash(req.body.password, 10)
      user.resetToken = undefined
      user.resetTokenExp = undefined
      await user.save()
      res.redirect('/auth/login')
    } else {
      req.flash('loginError', 'Время жизни токена истекло')
      res.redirect('/auth/login')
    }
  } catch (e) {
    console.log(e)
  }
})
```
Где: <br/>
**1. Поиск пользователя по ID:** <br/>
Логика поиска пользователя по ID: <br/>
```node
...
const user = await User.findOne({
      _id: req.body.userId,
      resetToken: req.body.token,
      ...
    })
...
```
Где: <br/>
- `User.findOne({})` - метод findOne модели User, который ищет первый объект который подпадает под выполнение условий, заложених в тело метода. <br/>
- `_id` - ключ принимающий значение ID пользователя приходящий в теле запроса req.body.userId. <br/>
- `resetToken` - ключ-условие, которое заложено в тело метода и которое сравнивает resetToken с токеном req.params.token, который приходит с телом запроса request.  <br/>
- `resetTokenExp` - ключ-условие, которое заложено в тело метода и которое сравнивает с помощью оператора $gt не привышает ли срок токена больше, чем время в которое выполняется запрос {Date.now()}. <br/>
 
**2. Проверка на срок жизни токена:**<br/>
Логика проверки на срок жизни токена: <br/>
```node
...
resetTokenExp: {$gt: Date.now()}
...
```
Где: <br/>
- `resetTokenExp` - ключ-условие, которое заложено в тело метода и которое сравнивает с помощью оператора $gt не привышает ли срок токена больше, чем время в которое выполняется запрос {Date.now()}. <br/>

**3. Сохранение нового пароля пользователя в базе данных и перенаправление на страницу "Логин":** <br/>
Логика сохранения нового пароля пользователя в базе данных и перенаправление на страницу "Логин": <br/>
```node
...
 if (user) {
      user.password = await bcrypt.hash(req.body.password, 10)
      user.resetToken = undefined
      user.resetTokenExp = undefined
      await user.save()
      res.redirect('/auth/login')
...
```
Где: <br/>
- `bcrypt.hash(req.body.password, 10)` - метод hash объекта bcrypt, который шифрует пароля, приходящий в запросе req.body.password в количестве - 10 символов. <br/>
- `user.resetToken` - переопределение свойства resetToken объекта user на значение - undefined. <br/>
- `user.resetTokenExp` - переопределение свойства resetTokenExp объекта user на значение - undefined. <br/>
- `user.save()` - метод save сохраняющий объект пользователя user в базе данных. <br/>
- `res.redirect()` - метод redirect объекта ответа response перенаправление на страницу с маршрутом '/auth/login'. <br/>